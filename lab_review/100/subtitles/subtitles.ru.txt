Добрый день, уважаемые студенты! Я рад вас всех видеть на сессии разбора лабораторной работы. Тема сегодняшней лабораторной работы – это миграция базы данных в сервис баз данных Amazon RDS. Итак, давайте начнем. Начинаем мы разбор лабораторной работы с главной страницы AWS Management Console. Переходим к первому заданию. Нам необходимо перейти в сервис Amazon RDS, чтобы создать инстанс базы данных. На главной странице сервиса Amazon RDS, необходимо нажать на кнопку Create database. Мы перейдем на специальную страницу для ввода входных данных. Здесь нам необходимо выбрать метод как Standard Create. Далее, как движок необходимо выбрать MariaDB. Там где Templates, необходимо выбрать опцию Dev/Test. DB instance identifier будет CafeDatabase. Ниже необходимо ввести данные о пользователе баз данных. Пользователь будет admin. Пароль копируем и вставляем со страницы задания лабораторной работы. Как тип инстанса выбираем t3.micro. Здесь хотел бы отметить, в рамках задания указано, что необходимо выбрать t2.micro, но это семейство сейчас недоступно и оно считается устаревшим. Поэтому мы выбираем более свежее поколение, это t3 и тот же самый размер инстанса micro. Следующая секция связана с хранилищем. В нашем случае, это General Purpose SSD (gp2) и как размер необходимо будет указать 20 гигабайтов. Следующее - Availability and durability. Необходимо выбрать опцию Do not create a standby instance. Мы не будем включать опцию Multi-AZ deployment, так как в рамках лабораторной работы это не нужно. Там где Connectivity необходимо указать как VPC - LabVPC. Как Subnet group выбираем lab-db-subnet-group, это private subnet group, где будет располагаться инстанс базы данных. Как Security group выбираем созданную security группу dbSG и здесь необходимо будет убрать галочку с дефолтовой security группы. Как availability zone выбираем us-east-1a. Где дополнительная конфигурация ничего менять не нужно, мы подключаемся по TCP порту 3306. В секции Monitoring необходимо будет убрать галочку Enable enhanced monitoring, так как это не нужно в рамках лабораторной работы и когда мы убираем галочку сама база данных будет создаваться намного быстрее. Отлично, мы прокручиваем до конца страницы, видим примерную стоимость инстанса базы данных в месяц. Здесь идет разбивка, отдельно оплачивается инстанс и отдельно оплачивается 20 гигабайтов хранилища. В итоге это все выходит в месяц меньше 15 долларов. Ок, мы все ввели, нам необходимо сейчас нажать на кнопку Create database. Нас направляет на страницу со списком баз данных. Сейчас вы видите единственную базу данных, которую мы создали, Status - Creating. Нам нет необходимости ждать когда она полностью создастся и будет активна. Переходим к следующему заданию. В рамках следующего задания нам необходимо перейти на сервис Amazon EC2. Нам необходимо воспользоваться строкой поиска сервисов, начать вводить EC2. Первая ссылка - это та, которая нам нужна. Далее, уже на странице сервиса Amazon EC2 воспользуемся левым навигационным меню и выберем опцию Instances. Нас направит на страницу со списком инстансов. Будет единственный инстанс с названием CafeServer. Это тот EC2 сервер, на котором установлено приложение, веб-сервер и находится база данных, которую мы будем переносить на отдельный сервис. Здесь нам необходимо скопировать публичный IP адрес и в новой вкладке в веб-браузере ввести этот IP адрес /cafe, чтобы перейти на веб-приложение. Откроется следующая страница. Необходимо проверить работоспособность приложения, поэтому необходимо перейти на вкладку Menu. Необходимо выбрать для любой позиции количество больше нуля и внизу нажать на кнопку Submit order. В нашем случае мы заказали 3 пончика по цене 1 доллар и всего вышло 3 доллара. Все верно. Давайте теперь откроем страницу с историей заказов и мы должны увидеть наш заказ под номером 25. Он здесь также отображается. Это говорит о том, что приложение сейчас корректно работает. Мы переходим к следующему заданию и здесь нам необходимо подключиться к нашему EC2 инстансу. Для этого воспользуемся сервисом Session Manager. Он находится в сервисе Systems Manager. Мы можем в строке поиска сервисов начать вводить Systems Manager и дальше воспользоваться навигационным меню слева, либо начать вводить имя необходимого нам сервиса, это Sessions Manager, и он у нас отобразится в секции Features. Давайте сделаем следующим образом и перейдем по ссылке Session Manager. Здесь, когда мы перейдем на главную страницу сервиса Session Manager, необходимо нажать на кнопку Start Session. Мы увидим Target Instances, на текущий момент это один-единственный вариант CafeServer. Необходимо его выбрать и нажать на кнопку Start Session. Как только вы это нажимаете, открывается новая вкладка в веб-браузере и вы видите окно Terminal. Здесь необходимо первой командой ввести bash для того, чтобы открылся bash shell. Далее необходимо вбить команду sudo su, чтобы начать вводить команды в роли root пользователя. Далее нам необходимо от root пользователя уже перейти к пользователю EC2 User. Для этого вводим команду su ec2-user и необходимо сделать проверку. Если мы введем команду whoami, в ответе увидим пользователя, под которым мы сейчас сидим. Если отображается EC2 User, значит все верно. Двигаемся дальше. Сейчас нам необходимо перейти на домашнюю папку пользователя EC2 User. Для этого необходимо ввести команду cd, то есть Change Directory, путь cd /home/ec2-user/. Если вы введете pwd, то здесь отобразится текущая директория и вы увидите, что вы находитесь по верному пути. Теперь нам необходимо проверить состояние баз данных, установленной на EC2 машине. Для этого необходимо ввести команду service mariadb status. Вы увидите большое сообщение и в этом сообщении увидите зеленым active (running), что говорит о том, что база данных сейчас активна. Если вы введете также команду mysql --version, вы увидите, что MariaDB использует движок mysql. Теперь необходимо подключиться к базе данных. Нужно добраться до пароля пользователя баз данных. Эти данные у нас хранятся в Parameter store. Давайте в строке поиска сервисов в AWS Management Console введем Parameter store, в секции Features увидим необходимую нам ссылку и перейдем по ней. Вы увидите 7 созданных параметров, каждый отвечает за что-то определенное. Нас интересует /cafe/dbPassword. Давайте откроем этот параметр и в значении value вы увидите пароль от root пользователя баз данных. Давайте ее скопируем и вернемся обратно к сессии подключения к EC2 инстансу. Здесь нам необходимо ввести команду подключения к базе данных это mysql -u root -p. Как только вы нажмете Enter у вас запросит пароль. Вам необходимо будет вставить скопированный пароль. Если вы все сделали верно, откроется промпт баз данных MariaDB и здесь вы уже можете вводить команды. Давайте введем следующие команды. Первым делом show databases вы увидите список баз данных в этой базе данных и также внутри находится интересующая нас база данных cafe_db. Далее, необходимо ввести команду use cafe_db, чтобы мы могли работать с таблицами в этой базе данных. Как только мы выбрали нужную нам базу данных, мы можем ввести команду show tables и увидим все таблицы, которые есть в этой базе данных. У нас 4 таблицы. Давайте теперь введем команду select all from order. Вы увидите все заказы, сделанные через приложение. Всего 25 заказов и самый последний это тот заказ, который мы сделали вместе с вами. Также мы можем ввести запрос select all from order item и вы увидите для каждого заказа какие товары в каком количестве и на какую сумму были выбраны. Отлично, у нас база данных работает. Все данные на месте. Теперь мы можем ввести команду mysqldump, чтобы создать дамп базы данных. Все данные перенесутся в файл CafeDbDump.sql. Как только нажмете на Enter, вас запросят ввести пароль и в случае если вы не увидите ошибки, это говорит о том, что дамп базы данных был успешно создан. Давайте проверим, что файл действительно появился. Введем команду ls и файл CafeDbDump.sql появится. Если мы посмотрим его содержание, то вы увидите вначале запускаются команды создания таблиц соответствующей структуры и после уже увидите запросы insert, где вводятся данные. Отлично, мы переходим к следующему заданию. Здесь нам необходимо будет убедиться в том, что база данных успешно создалась. Для этого переходим к сервису Amazon RDS. Необходимо убедиться, что статус Available, если это так, мы переходим на страницу с лабораторной работой и здесь необходимо добраться до страницы с вопросами. Для этого нажимаем на кнопку Details, в выпадающем списке нажимаем на кнопку Show и в всплывающем окне необходимо будет нажать на ссылку Access the multiple choice questions. На странице с вопросами вы всего увидите 4 вопроса, на все из них нам необходимо сейчас ответить. Первый вопрос: где запущен инстанс базы данных Amazon RDS? Следует обратить внимание, что необходимо выбрать опции, которые являются верными и most specific, то есть максимально детализированы. Например, вариант инстанс базы данных находится в AWS верный, но недостаточно детализирован. Ок, давайте посмотрим какие варианты ответов есть. Первый вариант утверждает, что он находится на уровне региона. Другой вариант, что он на уровне availability зоны, чуть точнее, но нужно проверить так ли это. Третий вариант говорит о том, что находится на edge location и последний вариант - все варианты верны. Давайте теперь вернемся на страницу со списком баз данных и посмотрим на столбец Region and AZ, мы видим, что наша база данных относится к availability зоне us-east-1a. Это говорит о том, что правильный ответ второй, так как он верный и максимально детализирован. Давайте теперь посмотрим на второй вопрос. Есть ли у инстанса баз данных привязанный публичный IP адрес? Давайте вернемся на страницу с деталями баз данных и посмотрим какая же информация здесь есть. Мы видим, что у нас есть Endpoint и определенный порт. Endpoint не является публичным IP адресом и наличие Endpoint не говорит о том, что из интернета можно к этой базе данных обратиться. Поэтому мы отвечаем на этот вопрос No. Третий вопрос: укажите значение Name tag для subnet-а, на котором расположен RDS инстанс. Следует обратить внимание, что указано на странице с деталями базы данных, а также посмотреть отдельно какие subnets есть у VPC. Как варианты ответов мы видим, есть Public subnet, Private subnet 1 и Private subnet 2. Это все имеющиеся subnets в нашем VPC. Давайте откроем страницу с деталями нашей базы данных. Мы видим, что она находится в availability zone us-east-1a. Также указан список из двух subnets. Давайте попробуем эти subnets найти в списке subnets. Для этого необходимо открыть сервис VPC. В левом навигационном меню перейти на ссылку Subnets и найти интересующие нас subnets. Мы видим, что name tag заполнен как Private subnet 1 и Private subnet 2. Как нам понять в каком из subnets находится наш инстанс базы данных? Ответ прост. Необходимо проверить в какой availability zone находится каждый из subnets. Для этого необходимо прокрутить правее эту таблицу и мы увидим, что Private subnet 1 находится в availability zone us-east-1a и Private subnet 2 находится в availability zone us-east-1b. Таким образом правильным ответом является второй Private subnet 1. Посмотрим на четвертый вопрос. Какое количество security group rules привязано к RDS инстансу? Для этого обратно переходим на страницу с деталями нашего RDS инстанса и необходимо прокрутить чуть ниже. Есть отдельная секция Security group rules. Мы видим, что у нас есть один единственный rule. Он разрешает outbound трафик на весь интернет. Отлично. Таким образом мы отвечаем на этот вопрос. Первый вариант ответа - значение 1. Переходим к следующему заданию, нам необходимо подключиться от EC2 инстанса к RDS инстансу. Первым делом нам необходимо скопировать endpoint нашего RDS инстанса и вернуться к странице с терминалом. Здесь необходимо ввести соответствующую команду. Обратите внимание, что пользователем является admin и пароль тот, который мы указывали в самом начале при создании RDS инстанса. Как только нажмете Enter попросят ввести пароль. Вставьте скопированный пароль и посмотрите, что случится. Команда долго будет стоять таким образом. Через некоторое время выйдет ошибка таймаута. Это говорит о том, что есть некоторые проблемы и нам дается подсказка, что проблема не в пользователе и не в пароле. Необходимо подумать, где же может быть проблема. Первым, то что приходит на ум, это действительно ли есть доступ по сети от EC2 инстанса к RDS инстансу, с учетом того, что они находятся в одном VPC, но в разных subnets. EC2 инстанс находится в public subnet, а RDS инстанс находится в private subnet. Таким образом, давайте проверим у RDS инстанса security группу. Вы можете найти ссылку на security группу во вкладке Connectivity and security и соответствующее поле VPC security groups. Как только мы на нее перейдем, во вкладке Inbound rules мы увидим, что не задано ни одного правила, которое разрешало бы входящий трафик. Давайте это исправим и нажмем на кнопку Edit inbound rules. Здесь необходимо нажать на кнопку Add rule и в поле Type ввести MYSQL/Aurora протокол и порт вставится автоматически. Как Source указываем Custom. Мы не можем указать весь интернет, так как это небезопасно с точки зрения безопасности, некорректно. Поэтому мы можем предоставить доступ к security группе, а security группа привязана к EC2 инстансу. Таким образом нам необходимо вернуться к нашему EC2 инстансу, выбрать его и во вкладке Security мы увидим security группу, к которой она привязана. Полностью ID запоминать не нужно, достаточно запомнить последние два символа, это c5. Возвращаемся обратно на страницу редактирования security группы базы данных и как только мы выбираем Source, активируется следующее поле, начнем вводить SG и отобразится список security групп, доступных на этом AWS аккаунте. Нам нужно выбрать ту, которая заканчивается на c5. В вашем случае будет другой ID, но идею вы поняли. Также является best practice и рекомендация от меня лично, всегда заполнять опциональное поле Description, так как вы создаёте эти записи один раз и когда вы возвращаетесь через некоторое время практически нереально вспомнить для чего вы это делали. А когда есть небольшой комментарий, вы можете очень легко вспомнить, вы её писали или нет, более того можно по содержанию этого текста понять для чего она была создана. Давайте введем EC2 SG, после этого нажмем на кнопку Save rules. Отлично, давайте теперь вернёмся обратно к окну терминала и попробуем ввести следующую команду nmap -Pn и endpoint нашего RDS инстанса. Отработает проверка портов и мы увидим в большом сообщении в самом конце, что порт 3306 TCP по протоколу TCP открыт. Это говорит о том, что мы по сети предоставили необходимые права, теперь попробуем подключиться к нашему инстансу RDS, используя предыдущую команду. Если мы все сделали правильно, мы сможем подключиться. Давайте теперь посмотрим какие базы данных есть в этом инстансе RDS. Для этого необходимо ввести команду show databases. Вы видите здесь 5 баз данных и здесь нет базы данных cafe_db. Все верно, так и должно быть, так как эта база данных пустая, сейчас там ничего нет. Давайте теперь выйдем с этого промпта и с bash shell введем команду для импорта дампа базы данных. Как только мы это сделаем, попросят ввести пароль, мы ее введем и если мы не увидим ошибки, это говорит о том, что дамп был успешно импортирован в наш RDS инстанс. Давайте теперь обратно попробуем подключиться к нашему инстансу и введем команду show databases. Мы видим, что база данных нашего приложения cafeDB появилась, давайте теперь ее выберем и посмотрим какие таблицы там есть. Мы видим, что все необходимые таблицы есть. Также посмотрим содержание таблицы Order, мы видим, что у нас есть 25 записей и последняя запись это тот заказ, который мы с вами вместе сделали. Отлично. Теперь мы двигаемся к следующему заданию. В этом задании нам необходимо произвести изменения в наших параметрах, так как приложение работает, используя эти параметры. Здесь у нас есть параметры, связанные с базой данных, это dbPassword и dbUrl. Давайте их обновим на соответствующие значения. Первым делом сделаем изменения в параметре dbPassword, необходимо ее открыть. Вверху справа нажать на кнопку Edit и ввести новое значение. После чего внизу страницы необходимо нажать на кнопку Save changes. Как только мы это сделаем, те же самые действия необходимо произвести с параметром dbUrl и здесь необходимо ввести endpoint инстанса RDS. Сохраняем изменения, возвращаемся к терминалу с подключением к EC2 инстансу и здесь для чистоты эксперимента остановим локальную базу данных. Для этого введем следующую команду и увидим соответствующий ответ. Теперь попробуем открыть приложение. Ссылка остается той же, так как мы веб-приложение и веб-сервер не меняли. Попробуем открыть вкладку Menu и увидим ошибку. Давайте подумаем, где же мы не произвели необходимые изменения. Вы можете сейчас остановить видео и попробовать ответить. Отлично, я надеюсь вы смогли правильно ответить. Правильным ответом является то, что у нас есть еще один параметр, связанный с базами данных, это dbUser. Если вы помните, в локальной базе данных мастер пользователем является root, а для инстанса RDS мы создавали мастер пользователя под названием admin. Поэтому нам необходимо ввести сейчас соответствующие изменения. После того как мы это сделаем, возвращаемся обратно на страницу с Menu и попробуем обновить страницу. Мы увидим список товаров и сейчас нам необходимо проверить работу веб-приложения. Выберем горячий шоколад в одном количестве и попробуем оставить заявку. Нас направят на страницу с нашим заказом, это заказ номер 26. Все необходимые данные корректно отобразились. Давайте теперь попробуем открыть страницу с историей заказов. Мы увидим, что и 25 и 26 заказ, который мы с вами вместе сделали, корректно отображаются. Отлично, на этом мы завершили все задания в рамках лабораторной работы. Если вы добрались до этого места, я вас поздравляю. Сейчас мы запустим автоматическое оценивание. Для этого необходимо вернуться обратно на страницу лабораторной работы и нажать на кнопку Submit. Здесь нам необходимо подтвердить, что мы хотим запустить автоматическое оценивание и через некоторое время, это может занять до двух минут, отработают все скрипты и с правой стороны вы увидите свою оценку. Если вы набрали максимальное количество баллов, я вас поздравляю, вы молодцы, все сделали корректно. Если же где-то не достает баллы, посмотрите в каком задании у вас не хватает баллов, необходимо вернуться к этому заданию и попробовать сделать его еще раз. Отлично, на этом мы завершаем лабораторную работу. Очень важно корректно выйти со всех систем. В первую очередь это относится к AWS Management Console. Необходимо в верхней правой части нажать на имя пользователя и далее нажать на кнопку Sign out. Если мы говорим про страницу с лабораторной работы, нам необходимо завершить корректно лабораторную работу. Для этого нажимаем на кнопку End lab, подтверждаем, что мы завершаем лабораторную работу и необходимо дождаться сообщения о том, что мы можем закрывать страницу AWS Academy. Отлично, я вас поздравляю, мы с вами завершили разбор лабораторной работы. Я очень надеюсь, что вы получили более полное представление о сервисах AWS. Спасибо за внимание. Увидимся с вами на следующих наших активностях.